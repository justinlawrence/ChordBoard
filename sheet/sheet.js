var song1 = `Escape
by Jesse Kongos

Verse 1:
D
Every few thousand years
Bm                       A
Come true man's greatest fears
Bm
All the living things
D
Mother nature brings - to tears

D
When the bombs are bursting in the air
Bm                                  A
And the rockets are making that red glare
Bm
I'm heading down
D
Down to that good hope town - where the weather's fair

Bm   G   D   A

Chorus:
Bm     A         Bm     D
So why don't you come away
G          A
With me my love
     Bm
We'll do what it takes
D
I'll keep you safe

Bm   A        Bm      D
Why don't you stay by me
G                 A
And when the time comes
Bm
We'll escape

Verse 2:
D
When the big one finally hit's LA
Bm                       A
When Yellowstone has it's day
Bm
We're heading to the southern tip
D
On a plane or on a ship
We'll do what it takes - we'll find a way

Verse 3:
D
And if that cloud forms up above
Bm                    A
No sign anywhere of a dove
Bm
There'll be no reason left to stay
D
We'll try and live another day
In a place where there's still love


Bm     A         Bm     D
So why don't you come away
G          A
With me my love
     Bm
We'll do what it takes
D
I'll keep you safe

Bm   A        Bm      D
Why don't you stay by me
G                 A
And when the time comes
Bm
We'll escape`;

var song2 = `Trouble
Coldplay

Verse 1:
 G  Em   Bm
oh no i see
F               Am              G
a spider web is tangled up with me
G     Em      Bm
and I lost my head
F                      Am                G
and thought of all the stupid things i’d said

Verse 2:
G  Em        Bm
oh no what’s this
F                    Am                   G
a spider web and i’m caught in the middle

G    Em        Bm
so I turned to run and
F                  Am                G
thought of all the stupid things i’d done

Chorus:
A                                 Em
and ah i never meant to cause you trouble
A                          Em
ah i never meant to do you wrong
A                            Em
ah well if I ever caused you trouble
A                                  Em
then oh no I never meant to do you harm.

Verse 3:
G  Em   Bm
oh no i see
F                     Am               G
a spider web and it’s me in the middle
G    Em        Bm
so i twist and turn
F                Am               G
but here am i in my little bubble

Bridge:
Em       F#m    G   F#m Em
and they spun a web for me
Em   F#m    G   F#m Em
they spun a web for me
Em       F#m    G   F#m Em
and they spun a web for me`;

var song3 = `Elohim
Marty Sampson

[Intro]
Eb Cm G# Fm

[Verse 1]
Eb
I stand upon the solid rock of faith in Christ
                                               G#
This steadfast shall not break apart within the trial
I am assured His promises will never fail
Fm
As long as life remains He is faithful

[Chorus]
Eb              Bb
God is patient, God is kind
G#               Fm
He does not envy, He does not boast
Eb                          Bb
His ways are higher than my own
                        Eb      G#
His thoughts consume the great unknown
                           Bb     Eb
Of this alone I am sure, my God is love

[Verse 2]
Eb
I draw my breath under His created windswept sky
                                                G#
I know my hope shall last long after my flesh retires
                                                 Fm
From dusk until the dawn He calls His children home

His righteous love outlasts generations

[Chorus]
Eb              Bb
God is patient, God is kind
G#               Fm
He does not envy, He does not boast
Eb                          Bb
His ways are higher than my own
                        Eb      G#
His thoughts consume the great unknown
                           Bb       Eb  G#   Eb Bb
Of this alone I am sure, my God is love

Bb Cm G# Eb

[Bridge]
       Bb          Cm      G#           Eb
He is Almighty God, Elohim, Maker of the Earth
         Bb             Cm             G#             Eb
He is the Lord of Hosts, Heaven's King, God of endless worth
           Bb           Cm           G#           Eb
His kingdom stands above every power, every living soul
           Bb            Cm         G#           Eb   Bb Cm G# Eb
His love is like the sun, ever true, shining over all`;

var song4 = `Angels we have heard on high
MercyMe
Verse 1:
Eb             Bb/D     Eb    Cm      Eb/Bb   Ab   Bb  Eb
Angels we have heard on high, sweetly singing o'er the plains
Eb                Bb/D Eb   Cm  Eb/Bb     Ab Bb  Eb
And the mountains in reply, echoing their joyous strains

Chorus:
Eb C Fm Bb/D Eb Ab/C Bb Ab Eb/G  Ab/F Eb/G Bb  Eb Ab Eb/Bb Bb Cm Fm Bb/G Ab Eb/Bb Bb Eb
Glo - ria
in excelsis deo,
glo - ria

in excelsis deo

Verse 2:
Eb/C          Bb/D    Eb   Cm        Eb/Bb Ab  Bb     Eb
Come to Bethlehem and see, Him whose birth the angels sing
Eb/C          Bb/D   Eb    Cm         Eb/Bb    Ab  Bb   Eb
Come adore on bended knee, Christ the Lord the new born King

Chorus 2:
Eb C Fm Bb/D Eb Ab/C Bb Ab Eb/G  Ab/F Eb/G Bb  Eb Ab Eb/Bb Bb Cm Fm Bb/G Ab Eb/Bb Bb Eb
Glo - ria in excelsis deo, glo - ria   in excelsis deo
Eb   C#           B                   Bb               Eb C F
Sing gloria, sing gloria, sing glory, oh sing glory x2

Verse 3:
F/D            C/E      F     Dm      F/C     Bb   C   F
Angels we have heard on high, sweetly singing o'er the plains
F/D               C/E   F   Dm  F/C       Bb C   F
And the mountains in reply, echoing their joyous strains

Chorus 3:
F D Gm C/E F Bb/D C  Bb F/A   Bb/G F/A C   F  Bb F/C C  Dm Gm C/A Bb F/C C F
Glo - ria in excelsis deo, glo - ria   in excelsis deo
F    Eb           C#                  C            F
Sing gloria, sing gloria, sing glory, oh sing glory x2

Verse 4:
F               Eb Cm   F    Eb/F F            Eb  Cm   F    Eb/F
Hark the herald angels sing , Glory to the new born King
F             Eb Cm    F     Eb/F
Joyful all ye nations rise, join the triumph of the skies
F            Eb   Cm C#
With angelic host proclaim

Chorus 4:
F    Eb           C#                  C             F
Sing gloria, sing gloria, sing glory, oh sing glory x2

Verse 5:
F              Bb            F
To a babe in a manger born a King
                Bb              F
Gloria hear the song the angels sing
                    Bb
Hear the mountains' echo ring
C#    Eb
Glory Hallelujah
F                 Bb            F
On the night in a stable came a boy
                        Bb              F
Prince of peace came to earth the skies rejoice
                    Bb
Heaven sings with a might voice
C#    Eb
Glory Hallelujah`;

require( './sheet.less' );

var songs = [song1, song2, song3, song4];
var currentIndex = 0;
var prevButton = document.querySelector(".prev-button");
var nextButton = document.querySelector(".next-button");

prevButton.addEventListener("click", () => {

	currentIndex--;
	currentIndex = Math.max(0, currentIndex);

	parseSong(songs[currentIndex]);

});

nextButton.addEventListener("click", () => {

	currentIndex++;
	currentIndex = Math.min(songs.length - 1, currentIndex);

	parseSong(songs[currentIndex]);

});

parseSong(songs[currentIndex]);

//-----------------------------------------------------

function parseSong(song) {

	var lines = parseLines(song);
	var sheetElement = document.getElementById("sheet");
	var html = "";
	var sections = [];
	var section = "";
	var sectionIndex = 0;

	for (var i = 0; i < lines.length; i++) {

		var line = lines[i];

		switch (lines[i].type) {

			case "chord-line":
				html += buildChordLine(line);
				break;

			case "chord-pair":
				html += buildChordPair(line);
				break;

			case "empty":
				html += buildEmptyLine();
				break;

			case "line":
				html += buildLine(line);
				break;

			case "section":

				if (section) {
					html += "</section>";
				}

				section = line.text;
				sections.push({
					title: line.text,
					index: sectionIndex
				});

				html += '<section id="section-' + sectionIndex + '" class="section" data-section="' + line.text + '">';
				html += buildSectionTitle(line);

				sectionIndex++;

				break;

			case "title":
				html += buildTitle(line);
				html += '<div id="sections"></div>';
				break;

		}

	}

	if (section) {
		html += "</section>";
	}

	sheetElement.innerHTML = html;

	renderSections(sections);

}

function parseLines(input) {

	var ENDS_WITH_COLON = /:$/;
	var SQUARE_BRACKET = /^\[(.*)\]$/;
	var lines = input.split("\n");
	var prevLine = "";
	var output = [];

	for (var i = 0; i < lines.length; i++) {

		var line = lines[i];

		if (line.trim() === "") {

			output.push({
				type: "empty",
				text: line
			});

		} else if (prevLine && isChords(prevLine) && !isChords(line)) {

			// Remove previous line from output because we want it to be
			// attached to the current line.
			output.pop();
			output.push({
				type: "chord-pair",
				chords: prevLine,
				text: line
			});

		} else {

			if (i === 0) {

				output.push({
					type: "title",
					text: line
				});

			} else if (i === 1) {

				output[0].artist = line;

			} else if (ENDS_WITH_COLON.test(line)) {

				output.push({
					type: "section",
					text: line.replace(ENDS_WITH_COLON, "")
				});

			} else if (SQUARE_BRACKET.test(line)) {

				output.push({
					type: "section",
					text: line.replace(SQUARE_BRACKET, "$1")
				});

			} else if (isChords(line)) {

				output.push({
					type: "chord-line",
					text: line
				});

			} else {

				output.push({
					type: "line",
					text: line
				});

			}

		}

		prevLine = line;

	}

	return output;

}

function isChords(input) {

	var output = input.replace(/(\s|[A-G](#|b)?m?|(sus|maj|min|aug|dim|add)\d?|\/|-|\|)/g, "");

	return !(output);

}

function buildChordLine(line) {

	return '<div class="chord-line">' + line.text + '</div>';

}

function buildChordPair(line) {

	var WORD_INDEX = /\b[A-G]/g;
	var result;
	var html = "";
	var chords = line.chords.replace(/\s+/g, " ").split(" ");

	var indices = [];
	while ((result = WORD_INDEX.exec(line.chords))) {

		indices.push(result.index);

	}

	// If the first index is not zero, then the first chord starts in the
	// middle of the line. So prepend a zero to keep text structure.
	if (indices[0] !== 0) {

		indices.unshift(0);

	}

	html += '<div class="chord-pair">';

	for (var i = 0; i < indices.length; i++) {

		var index = indices[i];
		var nextIndex = indices[i + 1] || Infinity;
		var slice = line.text.slice(index, nextIndex);

		html += '<span class="text-line" data-content="' + chords[i] + '">' + slice + '</span>';

	}

	html += "</div>";

	return html;

}

function buildEmptyLine() {

	return '<div class="empty-line"></div>';

}

function buildLine(line) {

	return '<div class="text-line">' + line.text + '</div>';

}

function buildSectionTitle(line) {

	return '<div class="section-title" >' + line.text + '</div>';

}

function buildTitle(line) {

	return '<div class="title">' + line.text +
		'<span class="artist">' + line.artist + '</span>' +
		'</div>';

}

function renderSections(sections) {

	var containerElement = document.getElementById("sections");

	sections.forEach((section, index) => {

		var element = document.createElement("a");
		element.innerText = section.title;
		element.addEventListener("click", () => {

			scrollToSection(section);

		});

		containerElement.appendChild(element);

		if (index < sections.length - 1) {

			var separator = document.createElement("span");
			separator.innerHTML = "&middot;"
			separator.className = "separator";
			containerElement.appendChild(separator);

		}

	});

}

function scrollToSection(section) {

	var totalVertPadding = 32;
	var headerHeight = 92;

	location.href = "#";
	location.href = "#section-" + section.index;

	var scrollBottom = window.innerHeight - document.body.scrollTop + totalVertPadding;

	if (headerHeight < scrollBottom) {

		// Go back 92 pixels to offset the header.
		window.scrollBy(0, -headerHeight);

	}

}